<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fat-Loss Tracker</title>
<link rel="manifest" href="manifest.webmanifest?v=3.11.2200">
<link rel="apple-touch-icon" href="icons/icon-192.svg?v=3.11.2200">
<meta name="theme-color" content="#0b5fff">
<style>
  :root{--bg:#f6f7f9;--fg:#111;--muted:#666;--card:#fff;--accent:#0b5fff;--ring:#3b82f6}
  html,body{height:100%;-webkit-overflow-scrolling:touch}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:12px}
  h1{font-size:20px;margin:10px 0 6px 0}
  .sub{color:var(--muted);font-size:12px;margin-bottom:8px}
  .apptabs{display:flex;flex-wrap:wrap;gap:8px;padding:8px 0;position:relative;z-index:5}
  .apptab{border:1px solid #ccc;border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
  .apptab.active{background:#000;color:#fff;border-color:#000}
  .weektabs{display:flex;flex-wrap:wrap;gap:8px;padding-bottom:8px}
  .weektab{border:1px solid #ccc;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .weektab.active{background:#000;color:#fff;border-color:#000}
  .row{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:10px;margin:8px 0}
  .row.today{outline:2px solid var(--ring)}
  .datewrap{display:flex;align-items:center;gap:6px}
  .badge{font-size:10px;background:#3b82f6;color:#fff;border-radius:999px;padding:2px 6px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px}
  .pill{background:#f3f4f6;border-radius:10px;padding:6px;text-align:center}
  .pill .t{font-weight:600;font-size:12px}
  .pill .v{font-size:12px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:6px}
  input, select{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  .btn{font-size:12px;border:1px solid #ddd;border-radius:8px;padding:6px 10px;background:#f3f4f6;cursor:pointer}
  .btn.danger{background:#fee2e2;color:#b91c1c;border-color:#fecaca}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px}
  .grid3{display:grid;grid-template-columns:1fr 90px 140px;gap:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-top:1px solid #e5e7eb;text-align:left}
  thead th{background:#f9fafb;color:#444;font-weight:600}
  canvas{max-width:100%}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Fat-Loss Tracker</h1>
    <div class="sub">v3.11 (TDEE 2200) • New trajectory & calorie targets</div>
  </header>

  <nav class="apptabs">
    <button class="apptab active" id="app-tracker">Tracker</button>
    <button class="apptab" id="app-train">Training Log</button>
    <button class="apptab" id="app-bw">Body Weight</button>
    <button class="apptab" id="app-trends">Lift Trends</button>
    <button class="apptab" id="app-proj">Weight Projection</button>
  </nav>

  <main>
    <section id="page-tracker"></section>
    <section id="page-train" style="display:none"></section>
    <section id="page-bw" style="display:none"></section>
    <section id="page-trends" style="display:none"></section>
    <section id="page-proj" style="display:none"></section>
  </main>
</div>

<script>
/* ===== Helpers ===== */
function isoLocal(d){ const dt=new Date(d); const y=dt.getFullYear(), m=('0'+(dt.getMonth()+1)).slice(-2), da=('0'+dt.getDate()).slice(-2); return y+'-'+m+'-'+da; }
function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
const SK={LIFTS:'flt-lifts', BW:'flt-bw'};

/* ===== Fixed params ===== */
const TDEE = 2200; // per user request
// Trajectory: 77 kg on Oct 14 -> 68 kg on Nov 29
const TRAJ_START_DATE = new Date('2025-10-14T00:00:00');
const TRAJ_START_WT = 77.0;
const TRAJ_END_DATE = new Date('2025-11-29T00:00:00');
const TRAJ_END_WT = 68.0;
// app range
const START=new Date('2025-10-12T00:00:00'), END=new Date('2025-12-01T00:00:00');

/* ===== Rotations, Travel, Workouts (sets×reps) ===== */
const PH=[{w:[1,2],p:175},{w:[3,4,5],p:175},{w:[6,7],p:175}];
function phase(w){ return PH.find(x=>x.w.includes(w))||PH[PH.length-1]; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function dn(d){ return d.toLocaleDateString('en-US',{weekday:'short'}); }
function lab(d){ return d.toLocaleDateString('en-US',{month:'short',day:'2-digit'}); }
function isCheat(d){ /* computed separately below */ return false; }
// travel Thu Oct 16 -> Mon Oct 20
const T_FROM=new Date('2025-10-16T00:00:00'), T_TO=new Date('2025-10-20T23:59:59');
function isTravel(d){ return d>=T_FROM && d<=T_TO; }
function wo(week, jsDay, d){
  if(isTravel(d)){
    if(jsDay===0) return "Travel — Active Recovery: Walk 30–40 min + mobility 10 min";
    return "Travel — Skipping 10×(30s/15s); Push-Ups 3×15–20; Bodyweight Squats 3×20; Plank 3×60s; (Opt) Burpees 2×10";
  }
  const b = week<=2?1:(week<=4?2:3);
  if(jsDay===1){ if(b===1) return "Push: Bench Press 4×8; Incline DB Press 3×10; Overhead Press 3×8; Cable Fly 3×15; Triceps Pushdown 3×12";
                 if(b===2) return "Push: DB Bench Press 4×8; Arnold Press 3×10; Pec Deck 3×15; Lateral Raise 3×15; Overhead Rope Extension 3×12";
                 return "Push: Close-Grip Bench 4×8; Seated DB Shoulder Press 3×10; Machine Fly 3×15; Lateral Raise 3×15; Skull Crushers 3×12"; }
  if(jsDay===2){ if(b===1) return "Pull: Deadlift 4×6; Lat Pulldown 3×10; Seated Row 3×10; Face Pull 3×15; DB Curl 3×10";
                 if(b===2) return "Pull: Rack Pull 4×6; Chin-Up 4×AMRAP; T-Bar Row 3×10; Rear Delt Fly 3×15; Hammer Curl 3×10";
                 return "Pull: Deadlift 4×6; DB Pullover 3×12; One-Arm Row 3×10; Face Pull 3×15; Cable Curl 3×12"; }
  if(jsDay===3){ if(b===1) return "Legs: Back Squat 4×8; Romanian Deadlift 3×10; Leg Press 3×12; Walking Lunge 3×12; Calf Raise 4×15";
                 if(b===2) return "Legs: Front Squat 4×6–8; Hip Thrust 3×10; Hack Squat 3×10; Step-Up 3×12; Calf Raise 4×15";
                 return "Legs: Bulgarian Split Squat 3×10/leg; Stiff-Leg Deadlift 3×10; Leg Extension 3×12; Leg Curl 3×12; Calf Raise 4×15"; }
  if(jsDay===4){ return "Cardio: Zone 2 30–40 min + Mobility 10 min"; }
  if(jsDay===5){ if(b===1) return "Upper Power: Bench 5×5; Barbell Row 5×5; Pull-Ups AMRAP; Dips 3×10; Hanging Leg Raise 3×15";
                 if(b===2) return "Upper Power: Incline Bench 5×5; Weighted Chin-Up 5×5; DB Row 3×10; Close-Grip Push-Up 3×15; Cable Crunch 3×15";
                 return "Upper Power: Flat DB Press 5×5; Pendlay Row 5×5; Pull-Up AMRAP; Dips 3×12; Ab Wheel Rollout 3×10"; }
  if(jsDay===6){ return "Cardio: Zone 2 30–40 min (or Skipping Intervals)"; }
  return "Rest / Active Recovery (Walk + Stretch)";
}

/* ===== Cheat days schedule ===== */
const CHEAT_DAYS = new Set();
// every 10 days from Oct 14
(function(){
  let d = new Date('2025-10-14T00:00:00');
  while (d <= new Date('2025-12-31T00:00:00')){ CHEAT_DAYS.add(isoLocal(d)); d = addDays(d,10); }
})();
// next Saturday after Oct 22, 2025 (Oct 25, 2025)
(function(){
  const now = new Date('2025-10-22T00:00:00');
  let d = new Date(now);
  while (d.getDay() !== 6) d = addDays(d,1);
  CHEAT_DAYS.add(isoLocal(d));
})();

/* ===== Calorie target calculator ===== */
const KCAL_PER_KG = 7700;
const total_deficit_needed = (TRAJ_START_WT - TRAJ_END_WT) * KCAL_PER_KG;
const allDays = []; let dd=new Date(TRAJ_START_DATE); while(dd<=TRAJ_END_DATE){ allDays.push(new Date(dd)); dd=addDays(dd,1); }
const cheatIntakes = allDays.map(d => CHEAT_DAYS.has(isoLocal(d)) ? 3000 : null);
const numNonCheat = cheatIntakes.filter(x => x===null).length;
const cheatDeficitSum = allDays.reduce((s,d,i)=>{ const c=cheatIntakes[i]; return s + ((0 if cheatIntakes[i] is None else (TDEE - cheatIntakes[i]))); }, 0)

// baseCal solves: sum(TDEE - intake) over window = total_deficit_needed
const baseCal = TDEE - ((total_deficit_needed - allDays.reduce((s, d, i) => s + (cheatIntakes[i]===null ? 0 : (TDEE - cheatIntakes[i])), 0)) / Math.max(1, numNonCheat));
const BASE_CAL = Math.max(1500, Math.min(2200, Math.round(baseCal)));

// macros per kcal
function macrosFor(kcal, proteinG=175){
  const pK = proteinG * 4;
  const fatK = Math.round(kcal * 0.30);
  const fatG = Math.max(35, Math.round(fatK / 9));
  const carbsK = Math.max(0, kcal - pK - fatG*9);
  const carbsG = Math.max(0, Math.round(carbsK / 4));
  return { p: proteinG, c: carbsG, f: fatG };
}

/* ===== Build plan with new calories ===== */
function buildPlan(){
  const out=[]; let d=new Date(START), w=1;
  while(d<=END){
    if(d.getDay()===1 && out.length) w++;
    const desc=wo(w,d.getDay(),d);
    let type = desc.startsWith("Cardio") ? "cardio"
             : (desc.startsWith("Upper Power")||desc.startsWith("Push")||desc.startsWith("Pull")||desc.startsWith("Legs")) ? "strength"
             : (desc.startsWith("Travel") ? (desc.includes("Skipping")?"hiit":"rest") : "rest");

    // calories/macros
    let cal = 1950, p = 175, c = 150, f = 60;
    const dIso = isoLocal(d);
    if (d >= new Date('2025-10-14') && d <= new Date('2025-11-29')){
      if (CHEAT_DAYS.has(dIso)){ cal = 3000; const m = macrosFor(cal, 150); p=m.p; c=m.c; f=m.f; type='rest'; }
      else { cal = BASE_CAL; const m = macrosFor(cal, 175); p=m.p; c=m.c; f=m.f; }
    }
    const burnMap = { strength: 400, cardio: 325, hiit: 275, rest: 150 };
    const burn = burnMap[type] || burnMap.rest;

    out.push({date:new Date(d), week:w, dayName:dn(d), label:lab(d), desc, type, cal, p, c, f, burn});
    d=addDays(d,1);
  }
  return out;
}
const planDays=buildPlan();

/* ===== Projection series (77kg Oct 14 -> 68kg Nov 29) ===== */
function projectedSeries(){
  const out=[]; let d=new Date(START);
  const S=new Date('2025-10-14'), E=new Date('2025-11-29');
  while(d<=END){
    let wt;
    if (d < S) wt = 77.0;
    else if (d > E) wt = 68.0;
    else { const t=(d - S)/(E - S); wt = +(77.0 + t*(68.0 - 77.0)).toFixed(1); }
    out.push({ date: isoLocal(d), wt });
    d=addDays(d,1);
  }
  return out;
}
const projected = projectedSeries();

/* ===== UI helpers ===== */
function el(tag, props={}, ...kids){ const e=document.createElement(tag); Object.entries(props).forEach(([k,v])=>{ if(k==='class') e.className=v; else if(k==='html') e.innerHTML=v; else e.setAttribute(k,v); }); kids.flat().forEach(k=>{ if(typeof k==='string') e.appendChild(document.createTextNode(k)); else if(k) e.appendChild(k); }); return e; }
function clear(n){ while(n.firstChild) n.removeChild(n.firstChild); }

/* ===== Pages ===== */
function renderTracker(){
  const root=document.getElementById('page-tracker'); clear(root);
  const today=new Date();
  // group by week
  const map=new Map(); planDays.forEach(d=>{ if(!map.has(d.week)) map.set(d.week,[]); map.get(d.week).push(d); });
  const weeks=[...map.entries()].map(([w,items])=>({week:w,items}));
  let activeWeek=weeks.find(w=>w.items.some(x=>sameDay(x.date,today)))?.week || weeks[0].week;

  const chips=el('div',{class:'weektabs'});
  weeks.forEach(w=>{ const b=el('button',{class:'weektab'+(w.week===activeWeek?' active':'' )},`Week ${w.week}`);
    b.addEventListener('click',()=>{ activeWeek=w.week; draw(); });
    chips.appendChild(b);
  });
  root.append(chips);

  const container=el('div'); root.append(container);

  function draw(){
    clear(container);
    const w=weeks.find(x=>x.week===activeWeek);
    container.append(el('div',{class:'sub'},`Week ${w.week}`));
    w.items.forEach(d=>{
      const isToday=sameDay(d.date,today);
      const li=el('div',{class:'row'+(isToday?' today':'')});
      const head=el('div',{class:'datewrap'}); head.append(el('div',{}, d.dayName+' '+d.label)); if(isToday) head.append(el('span',{class:'badge'},'TODAY'));
      li.append(head);
      li.append(el('div',{}, '🏋️ ', d.desc));
      const grid=el('div',{class:'grid'});
      [['Burn',d.burn+' kcal'],['Food',d.cal+' kcal'],['Carbs',d.c+' g'],['Fat',d.f+' g']].forEach(([t,v])=> grid.append(el('div',{class:'pill'}, el('div',{class:'t'},t), el('div',{class:'v'},v))));
      li.append(grid);
      const grid2=el('div',{class:'grid2'});
      const proj = projected.find(p=>p.date===isoLocal(d.date));
      [['Protein',d.p+' g'],['Projected Wt', proj ? proj.wt+' kg' : '']]
        .forEach(([t,v])=> grid2.append(el('div',{class:'pill'}, el('div',{class:'t'},t), el('div',{class:'v'},v))));
      container.appendChild(li);
    });
  }
  draw();
}

/* Training Log */
function renderTrain(){
  const root=document.getElementById('page-train'); clear(root);
  const entries=JSON.parse(localStorage.getItem(SK.LIFTS)||'[]');
  const row=el('div',{class:'card'});
  const sel=el('select',{id:'tl-ex'}); ["Bench Press","Incline DB Press","Overhead Press","Cable Fly","Lateral Raise","Triceps Pushdown","Deadlift","Lat Pulldown","Seated Row","Face Pull","DB Curl","Hammer Curl","Back Squat","Romanian Deadlift","Leg Press","Walking Lunge","Calf Raise","Pull-ups","Dips","Core"].forEach(x=> sel.append(el('option',{value:x},x)));
  const wt=el('input',{id:'tl-w',type:'number',placeholder:'kg'}), reps=el('input',{id:'tl-r',type:'number',placeholder:'reps'}), date=el('input',{id:'tl-d',type:'date',value: isoLocal(new Date())});
  const add=el('button',{id:'tl-add',class:'btn',type:'button'},'Add');
  row.append(el('div',{class:'grid3'}, sel, wt, reps), el('div',{}, date,' ', add));
  root.append(row);

  const by=new Map(); entries.forEach(e=>{ if(!by.has(e.exercise)) by.set(e.exercise,[]); by.get(e.exercise).push(e); });
  [...by.keys()].sort().forEach(ex=>{
    const sec=el('div',{class:'card'});
    sec.append(el('div',{class:'sub',html:'<b>'+ex+'</b>'}));
    const tbl=el('table'); tbl.innerHTML='<thead><tr><th>Date</th><th>Weight (kg)</th><th>Reps</th><th></th></tr></thead>';
    const tb=el('tbody');
    by.get(ex).sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
      const tr=el('tr');
      tr.append(el('td',{}, r.date), el('td',{}, String(r.weight)), el('td',{}, String(r.reps)));
      const del=el('button',{class:'btn danger',type:'button','data-action':'del-lift','data-id':r.id},'Delete');
      tr.append(el('td',{}, del)); tb.append(tr);
    });
    tbl.append(tb); sec.append(tbl); root.append(sec);
  });
}

/* Body Weight */
function renderBW(){
  const root=document.getElementById('page-bw'); clear(root);
  const arr=JSON.parse(localStorage.getItem(SK.BW)||'[]');
  const card=el('div',{class:'card'});
  const wt=el('input',{id:'bw-w',type:'number',placeholder:'kg'}), date=el('input',{id:'bw-d',type:'date',value: isoLocal(new Date())});
  const add=el('button',{id:'bw-add',class:'btn',type:'button'},'Add/Update');
  card.append(el('div',{class:'grid3'}, wt, add, date));
  root.append(card);

  const tbl=el('table',{class:'card'}); tbl.innerHTML='<thead><tr><th>Date</th><th>Weight (kg)</th><th></th></tr></thead>';
  const tb=el('tbody');
  arr.forEach(r=>{ const tr=el('tr'); tr.append(el('td',{}, r.date), el('td',{}, String(r.weight))); const del=el('button',{class:'btn danger',type:'button','data-action':'del-bw','data-date':r.date},'Delete'); tr.append(el('td',{}, del)); tb.append(tr); });
  tbl.append(tb); root.append(tbl);
}

/* Trends / Projection */
function epley1RM(w,r){ return w*(1+r/30); }
function renderTrends(){
  const root=document.getElementById('page-trends'); clear(root);
  const entries=JSON.parse(localStorage.getItem(SK.LIFTS)||'[]');
  const sel=el('select'); ["Bench Press","Incline DB Press","Overhead Press","Cable Fly","Lateral Raise","Triceps Pushdown","Deadlift","Lat Pulldown","Seated Row","Face Pull","DB Curl","Hammer Curl","Back Squat","Romanian Deadlift","Leg Press","Walking Lunge","Calf Raise","Pull-ups","Dips","Core"].forEach(x=> sel.append(el('option',{value:x},x)));
  root.append(el('div',{}, sel));
  const can=el('canvas'); can.height=320; root.append(el('div',{class:'card'}, can));
  let chart; function draw(){ const arr=entries.filter(e=>e.exercise===sel.value).sort((a,b)=>a.date.localeCompare(b.date));
    const labels=arr.map(e=>e.date), values=arr.map(e=>Math.round(epley1RM(e.weight||0,e.reps||1)*10)/10);
    if(chart) chart.destroy(); chart=new Chart(can.getContext('2d'), {type:'line', data:{labels, datasets:[{label:'Est. 1RM (kg)', data:values, borderColor:'#0b5fff', tension:0.2, pointRadius:2}]}, options:{maintainAspectRatio:false}}); }
  sel.addEventListener('change', draw); draw();
}
function renderProj(){
  const root=document.getElementById('page-proj'); clear(root);
  const bw=JSON.parse(localStorage.getItem(SK.BW)||'[]'); const bwMap=new Map(bw.map(x=>[x.date,x.weight]));
  const labels=[], projWt=[], realWt=[];
  let d=new Date(START);
  while(d<=END){ const iso=isoLocal(d); labels.push(iso);
    // projected
    let wt;
    const S=new Date('2025-10-14'), E=new Date('2025-11-29');
    if (d < S) wt = 77.0;
    else if (d > E) wt = 68.0;
    else { const t=(d - S)/(E - S); wt = +(77.0 + t*(68.0 - 77.0)).toFixed(1); }
    projWt.push(wt);
    // realized
    realWt.push(bwMap.get(iso) ?? null);
    d=addDays(d,1);
  }
  const can=el('canvas'); can.height=320; const card=el('div',{class:'card'}, can); root.append(card);
  new Chart(can.getContext('2d'), {type:'line', data:{labels, datasets:[{label:'Projected (kg)', data:projWt, borderColor:'#0b5fff', tension:0.25, pointRadius:0}, {label:'Realized (kg)', data:realWt, borderColor:'#16a34a', tension:0.2, pointRadius:3}]}, options:{maintainAspectRatio:false}});
}

/* Event delegation */
if(!window.__delegated){
  document.addEventListener('click',(e)=>{
    const t=e.target; if(!(t instanceof Element)) return;
    // main tabs
    if(t.id && t.id.startsWith('app-')){
      const id=t.id.replace('app-',''); const ids=['tracker','train','bw','trends','proj'];
      ids.forEach(n=> document.getElementById('page-'+n).style.display=(n===id)?'block':'none');
      document.querySelectorAll('.apptab').forEach(btn=> btn.classList.toggle('active', btn.id==='app-'+id));
      if(id==='tracker') renderTracker(); if(id==='train') renderTrain(); if(id==='bw') renderBW(); if(id==='trends') renderTrends(); if(id==='proj') renderProj();
      return;
    }
    // add/delete
    if(t.id==='tl-add'){ const ex=(document.getElementById('tl-ex')||{}).value||'Bench Press'; const w=Number((document.getElementById('tl-w')||{}).value||0); const r=Number((document.getElementById('tl-r')||{}).value||0); const d=(document.getElementById('tl-d')||{}).value||isoLocal(new Date()); const arr=JSON.parse(localStorage.getItem(SK.LIFTS)||'[]'); arr.push({id:crypto.randomUUID(), date:d, exercise:ex, weight:w, reps:r}); localStorage.setItem(SK.LIFTS, JSON.stringify(arr)); renderTrain(); return; }
    if(t.dataset && t.dataset.action==='del-lift'){ const id=t.dataset.id; const arr=(JSON.parse(localStorage.getItem(SK.LIFTS)||'[]')).filter(x=>x.id!==id); localStorage.setItem(SK.LIFTS, JSON.stringify(arr)); renderTrain(); return; }
    if(t.id==='bw-add'){ const vdate=(document.getElementById('bw-d')||{}).value||''; const vwt=Number((document.getElementById('bw-w')||{}).value||0); if(!vdate){ alert('Pick a date'); return; } const a=(JSON.parse(localStorage.getItem(SK.BW)||'[]')).filter(x=>x.date!==vdate); a.push({date:vdate, weight:vwt}); a.sort((a,b)=>a.date.localeCompare(b.date)); localStorage.setItem(SK.BW, JSON.stringify(a)); renderBW(); if(window.__page==='proj') renderProj(); return; }
    if(t.dataset && t.dataset.action==='del-bw'){ const d=t.dataset.date; const a=(JSON.parse(localStorage.getItem(SK.BW)||'[]')).filter(x=>x.date!==d); localStorage.setItem(SK_BW, JSON.stringify(a)); renderBW(); if(window.__page==='proj') renderProj(); return; }
  });
  window.__delegated=true;
}

// initial
renderTracker();
</script>
</body>
</html>
