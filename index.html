<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fat-Loss Tracker</title>
<link rel="manifest" href="manifest.webmanifest?v=3.1">
<link rel="apple-touch-icon" href="icons/icon-192.svg?v=3.1">
<meta name="theme-color" content="#0b5fff">
<style>
  :root{--bg:#f6f7f9;--fg:#111;--muted:#666;--card:#fff;--accent:#0b5fff;--ok:#0a7b34;--ring:#3b82f6;--warn:#b45309;}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:12px}
  h1{font-size:20px;margin:10px 0 6px 0}
  .sub{color:var(--muted);font-size:12px;margin-bottom:8px}
  .tabs{display:flex;gap:8px;overflow:auto;padding-bottom:8px}
  .tab{border:1px solid #ccc;border-radius:999px;padding:6px 10px;background:#fff;white-space:nowrap;cursor:pointer}
  .tab.active{background:#000;color:#fff;border-color:#000}
  .row{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:10px;margin:8px 0}
  .row.today{outline:2px solid var(--ring)}
  .row-head{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .caps{font-size:11px;color:var(--muted);width:36px;text-align:center;font-weight:600}
  .date{font-weight:700}
  .work{display:flex;gap:6px;color:#222;margin-top:6px}
  .icon{font-size:14px;line-height:1.2}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px}
  .pill{background:#f3f4f6;border-radius:10px;padding:6px;text-align:center}
  .pill .t{font-weight:600;font-size:12px}
  .pill .v{font-size:12px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:6px}
  input[type="text"],input[type="number"],input[type="date"],select{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  .btn{font-size:12px;border:1px solid #ddd;border-radius:8px;padding:6px 10px;background:#f3f4f6;cursor:pointer}
  .btn.danger{background:#fee2e2;color:#b91c1c;border-color:#fecaca}
  .toast{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;border-radius:8px;padding:6px 10px;display:inline-block;margin-top:8px}
  .toast.warn{background:#fffbeb;border-color:#fcd34d;color:#92400e}
  .summary{background:#000;color:#fff;border-radius:14px;padding:10px;margin-top:10px}
  .summary .g{display:grid;grid-template-columns:repeat(3,1fr);text-align:center;gap:4px}
  .muted{color:#cbd5e1;font-size:12px}
  .goal{font-weight:600}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px}
  .grid3{display:grid;grid-template-columns:1fr 90px 90px;gap:8px}
  .warnbox{background:#fffbeb;border:1px solid #fcd34d;color:#92400e;border-radius:8px;padding:6px 10px;margin:8px 0}
  canvas{max-width:100%}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Fat-Loss Tracker</h1>
    <div class="sub">v3.1 â€¢ Offline-ready â€¢ Local storage fallback included</div>
    <div id="storageWarn" class="warnbox" style="display:none">Heads up: persistent storage is unavailable (Private mode or restrictions). Your data will be kept temporarily while this app is open. Export JSON to save a backup.</div>
  </header>

  <nav class="tabs">
    <button class="tab active" id="tab-tracker">Tracker</button>
    <button class="tab" id="tab-train">Training Log</button>
    <button class="tab" id="tab-bw">Body Weight</button>
    <button class="tab" id="tab-trends">Lift Trends</button>
    <button class="tab" id="tab-proj">Weight Projection</button>
  </nav>

  <main>
    <section id="page-tracker"></section>
    <section id="page-train" style="display:none"></section>
    <section id="page-bw" style="display:none"></section>
    <section id="page-trends" style="display:none"></section>
    <section id="page-proj" style="display:none"></section>
  </main>
</div>

<script>
// ---- Storage with fallback ----
function storageAvailable(){
  try{ const x='__t__'; window.localStorage.setItem(x,'1'); window.localStorage.removeItem(x); return true; }
  catch(e){ return false; }
}
const MEM = { 'flt-lifts': [], 'flt-bw': [] };
const HAS_LS = storageAvailable();
if(!HAS_LS){ document.getElementById('storageWarn').style.display='block'; }
const LS = {
  get(k){ 
    if(HAS_LS){ try{ return JSON.parse(window.localStorage.getItem(k) || '[]'); }catch{return[]} }
    return MEM[k] || [];
  },
  set(k,v){
    if(HAS_LS){ window.localStorage.setItem(k, JSON.stringify(v)); }
    MEM[k] = v;
  }
};

// ---- Dates / plan ----
function isoLocal(d){ const dt=new Date(d); const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), da=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
const START = new Date('2025-10-12T00:00:00');
const END   = new Date('2025-12-01T00:00:00');
const GOAL  = [75.8,74.6,73.2,71.8,70.3,68.8,67.0];
const PHASES = [
  { weeks:[1,2], cal:1950, p:175, c:160, f:60, burn:{strength:375, cardio:300, hiit:250, rest:150} },
  { weeks:[3,4,5], cal:1800, p:175, c:130, f:55, burn:{strength:425, cardio:350, hiit:300, rest:150} },
  { weeks:[6,7], cal:1950, p:175, c:150, f:60, burn:{strength:325, cardio:275, hiit:250, rest:150} },
];
const EXERCISES = ["Bench Press","Incline DB Press","Overhead Press","Cable Fly","Lateral Raise","Triceps Pushdown","Deadlift","Lat Pulldown","Seated Row","Face Pull","DB Curl","Hammer Curl","Back Squat","Romanian Deadlift","Leg Press","Walking Lunge","Calf Raise","Pull-ups","Dips","Core"];
const SK = { LIFTS:'flt-lifts', BW:'flt-bw' };

function phaseForWeek(w){ return PHASES.find(ph=>ph.weeks.includes(w)) || PHASES[PHASES.length-1]; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function dn(d){ return d.toLocaleDateString('en-US',{weekday:'short'}); }
function lab(d){ return d.toLocaleDateString('en-US',{month:'short',day:'2-digit'}); }
function sameDay(a,b){ return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }
function isCheat(d){ const k=Math.floor((d-START)/86400000); return k>=0 && k%10===6; }

function buildPlan(){
  const days=[]; let d=new Date(START), week=1;
  while(d<=END){
    if(d.getDay()===1 && days.length) week++;
    const ph = phaseForWeek(week);
    let desc, type;
    switch(d.getDay()){
      case 1: desc="Push: Bench 4x8; Incline DB Press 3x10; Overhead Press 3x8; Cable Fly 3x15; Lateral Raise 3x15; Triceps Pushdown 3x12"; type="strength"; break;
      case 2: desc="Pull: Deadlift 4x6; Lat Pulldown 3x10; Seated Row 3x10; Face Pull 3x15; DB Curl 3x10; Hammer Curl 3x10"; type="strength"; break;
      case 3: desc="Legs: Back Squat 4x8; Romanian Deadlift 3x10; Leg Press 3x12; Walking Lunge 3x12; Calf Raise 4x15"; type="strength"; break;
      case 4: desc="Cardio 40 min Zone 2; Mobility"; type="cardio"; break;
      case 5: desc="Upper Power: Bench 5x5; Barbell Row 5x5; Pull-ups AMRAP; Dips 3x10; Core 3x15"; type="strength"; break;
      case 6: desc="Cardio 30-40 min Zone 2 or Cheat Day (3000 kcal)"; type="cardio"; break;
      default: desc="Rest / Active Recovery (Walk or Stretch)"; type="rest";
    }
    let cal=ph.cal, p=ph.p, c=ph.c, f=ph.f;
    if(week===1 && [4,5,6,0].includes(d.getDay())){
      if(d.getDay()===0){ desc="Cheat Day / Rest (Social)"; type="rest"; cal=3000; }
      else { desc="Skipping HIIT 20 min; Push-ups 4x20; Bodyweight Squats 4x20; Plank 3x60s"; type="hiit"; }
    }
    if(isCheat(d)){ cal=3000; type='rest'; }
    const burn=ph.burn[type];
    days.push({date:new Date(d), week, dayName:dn(d), label:lab(d), desc, type, cal, p, c, f, burn, goal: GOAL[Math.min(week-1,GOAL.length-1)]});
    d=addDays(d,1);
  }
  return days;
}
const planDays = buildPlan();

function el(tag, props={}, ...kids){
  const e = document.createElement(tag);
  Object.entries(props).forEach(([k,v])=>{
    if(k==='class') e.className=v; else if(k==='html') e.innerHTML=v; else e.setAttribute(k,v);
  });
  kids.flat().forEach(k=>{ if(typeof k==='string') e.appendChild(document.createTextNode(k)); else if(k) e.appendChild(k); });
  return e;
}
function clear(node){ while(node.firstChild) node.removeChild(node.firstChild); }

function renderTracker(){
  const root = document.getElementById('page-tracker'); clear(root);
  const today = new Date();
  const map = new Map(); planDays.forEach(d=>{ if(!map.has(d.week)) map.set(d.week, []); map.get(d.week).push(d); });
  const weeks = Array.from(map.entries()).map(([w,items])=>({week:w,items}));
  let activeWeek = weeks.find(w=>w.items.some(x=>sameDay(x.date,today)))?.week || weeks[0].week;

  const tabs = el('div',{class:'tabs'});
  weeks.forEach(w=>{
    const b = el('button',{class:'tab'+(w.week===activeWeek?' active':'' )}, `Week ${w.week}`);
    b.onclick = ()=>{ activeWeek=w.week; draw(); };
    tabs.appendChild(b);
  });
  root.appendChild(tabs);

  const container = el('div'); root.appendChild(container);

  function draw(){
    clear(container);
    const w = weeks.find(x=>x.week===activeWeek);
    const totalIn = w.items.reduce((s,d)=>s+d.cal,0);
    const totalOut = w.items.reduce((s,d)=>s+d.burn,0);
    const title = el('div',{class:'sub'}, `Week ${w.week} â€¢ Goal `, el('span',{class:'goal'}, `${w.items[0].goal.toFixed(1)} kg`));
    container.appendChild(title);

    w.items.forEach(d=>{
      const li = el('div',{class:'row'+(sameDay(d.date,today)?' today':'')});
      const head = el('div',{class:'row-head'});
      const left = el('div',{style:'display:flex;gap:8px;align-items:center'});
      left.append(el('div',{class:'caps'}, d.dayName));
      const dt = el('div',{class:'date'}, d.label);
      if(sameDay(d.date,today)){ const badge = el('span',{style:'background:#0b5fff;color:#fff;border-radius:999px;padding:2px 6px;font-size:11px;margin-left:6px'},'TODAY'); dt.append(' ', badge); }
      left.append(dt);
      head.append(left);
      li.append(head);

      li.append(el('div',{class:'work'}, el('div',{class:'icon'},'ðŸ‹ï¸'), el('p',{}, d.desc)));
      const grid = el('div',{class:'grid'});
      [['Burn', d.burn+' kcal'], ['Food', d.cal+' kcal'], ['Carbs', d.c+' g'], ['Fat', d.f+' g']].forEach(([t,v])=>{
        grid.append(el('div',{class:'pill'}, el('div',{class:'t'},t), el('div',{class:'v'},v)));
      });
      li.append(grid);
      const grid2 = el('div',{class:'grid2'});
      [['Protein', d.p+' g'], ['Goal', w.items[0].goal.toFixed(1)+' kg']].forEach(([t,v])=>{
        grid2.append(el('div',{class:'pill'}, el('div',{class:'t'},t), el('div',{class:'v'},v)));
      });
      li.append(grid2);
      if(isCheat(d.date)){ li.append(el('div',{class:'cheat'}, el('span',{},'âš¡'), el('span',{},'Cheat day scheduled'))); }
      container.appendChild(li);
    });

    const sum = el('div',{class:'summary'});
    sum.innerHTML = '<div>ðŸ“† Weekly Summary</div><div class="g"><div><div class="muted">Food</div><div><b>'+totalIn+'</b></div></div><div><div class="muted">Burn</div><div><b>'+totalOut+'</b></div></div><div><div class="muted">Net</div><div><b>'+(totalOut-totalIn)+' kcal</b></div></div></div>';
    container.appendChild(sum);
  }
  draw();
}

function renderTrain(){
  const root = document.getElementById('page-train'); clear(root);
  const entries = LS.get(SK.LIFTS);
  const row = el('div',{class:'card'});
  const sel = el('select'); EXERCISES.forEach(x=> sel.append(el('option',{value:x},x)));
  const date = el('input',{type:'date', value: isoLocal(new Date())});
  const wt = el('input',{type:'number', placeholder:'kg'});
  const reps = el('input',{type:'number', placeholder:'reps'});
  const toast = el('div',{class:'toast', style:'display:none'}, HAS_LS ? 'Saved' : 'Saved (temporary)');
  const add = el('button',{class:'btn', onclick:()=>{
    const rec = { id: crypto.randomUUID(), date: date.value, exercise: sel.value, weight: Number(wt.value||0), reps: Number(reps.value||0) };
    const arr = LS.get(SK.LIFTS); arr.push(rec); LS.set(SK.LIFTS, arr);
    toast.style.display='inline-block'; setTimeout(()=>toast.style.display='none', 1200);
    renderTrain();
  }}, 'Add');
  row.append(el('div',{class:'grid3'}, sel, wt, reps));
  row.append(el('div',{}, date, ' ', add, ' ', toast));
  root.append(row);

  const by = new Map(); entries.forEach(e=>{ if(!by.has(e.exercise)) by.set(e.exercise, []); by.get(e.exercise).push(e); });
  [...by.keys()].sort().forEach(ex=>{
    const sec = el('div',{class:'card'});
    sec.append(el('div',{class:'sub', html:'<b>'+ex+'</b>'}));
    const tbl = el('table',{style:'width:100%'});
    tbl.innerHTML='<thead><tr><th>Date</th><th>Weight (kg)</th><th>Reps</th><th></th></tr></thead>';
    const tb = el('tbody');
    by.get(ex).sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
      const tr = el('tr'); tr.append(el('td',{}, r.date), el('td',{}, String(r.weight)), el('td',{}, String(r.reps)));
      const del = el('button',{class:'btn danger', onclick:()=>{ const arr=LS.get(SK.LIFTS).filter(x=>x.id!==r.id); LS.set(SK.LIFTS, arr); renderTrain(); }}, 'Delete');
      tr.append(el('td',{}, del)); tb.append(tr);
    });
    tbl.append(tb); sec.append(tbl); root.append(sec);
  });

  const tools = el('div',{class:'card'});
  const expBtn = el('button',{class:'btn', onclick:()=>{
    const data = JSON.stringify(LS.get(SK.LIFTS), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='training-log.json'; a.click(); URL.revokeObjectURL(url);
  }}, 'Export training JSON');
  const file = el('input',{type:'file', accept:'application/json'});
  file.onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{ try{ const data=JSON.parse(reader.result); if(Array.isArray(data)){ LS.set(SK.LIFTS, data); renderTrain(); } }catch{} };
    reader.readAsText(f);
  };
  tools.append(expBtn, ' ', file);
  root.append(tools);
}

function renderBW(){
  const root = document.getElementById('page-bw'); clear(root);
  const arr = LS.get(SK.BW);
  const card = el('div',{class:'card'});
  const date = el('input',{type:'date', value: isoLocal(new Date())});
  const wt = el('input',{type:'number', placeholder:'kg'});
  const toast = el('div',{class:'toast', style:'display:none'}, HAS_LS ? 'Saved' : 'Saved (temporary)');
  const add = el('button',{class:'btn', onclick:()=>{
    const a = LS.get(SK.BW).filter(x=>x.date!==date.value);
    a.push({date: date.value, weight: Number(wt.value||0)}); a.sort((a,b)=>a.date.localeCompare(b.date)); LS.set(SK.BW,a);
    toast.style.display='inline-block'; setTimeout(()=>toast.style.display='none', 1200);
    renderBW(); if(window.__page==='proj') renderProj();
  }}, 'Add/Update');
  row = document.createElement('div'); row.className='grid3'; row.append(wt, add, date);
  card.append(row, toast);
  root.append(card);

  const tbl = el('table',{class:'card', style:'width:100%'});
  tbl.innerHTML='<thead><tr><th>Date</th><th>Weight (kg)</th><th></th></tr></thead>';
  const tb = el('tbody');
  arr.forEach(r=>{
    const tr = el('tr'); tr.append(el('td',{},r.date), el('td',{}, String(r.weight)));
    const del = el('button',{class:'btn danger', onclick:()=>{ const x=LS.get(SK.BW).filter(y=>y.date!==r.date); LS.set(SK.BW,x); renderBW(); if(window.__page==="proj") renderProj(); }}, 'Delete');
    tr.append(el('td',{}, del)); tb.append(tr);
  });
  tbl.append(tb); root.append(tbl);

  const tools = el('div',{class:'card'});
  const expBtn = el('button',{class:'btn', onclick:()=>{
    const data = JSON.stringify(LS.get(SK.BW), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='bodyweight.json'; a.click(); URL.revokeObjectURL(url);
  }}, 'Export weight JSON');
  const file = el('input',{type:'file', accept:'application/json'});
  file.onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{ try{ const data=JSON.parse(reader.result); if(Array.isArray(data)){ LS.set(SK.BW, data); renderBW(); if(window.__page==='proj') renderProj(); } }catch{} };
    reader.readAsText(f);
  };
  tools.append(expBtn, ' ', file);
  root.append(tools);
}

function epley1RM(w,r){ return w*(1+r/30); }

function renderTrends(){
  const root = document.getElementById('page-trends'); clear(root);
  const entries = LS.get(SK.LIFTS);
  const sel = el('select'); EXERCISES.forEach(x=> sel.append(el('option',{value:x},x)));
  root.append(el('div',{}, sel));
  const can = el('canvas'); can.height=320; root.append(el('div',{class:'card'}, can));
  let chart;
  function draw(){
    const arr = entries.filter(e=>e.exercise===sel.value).sort((a,b)=>a.date.localeCompare(b.date));
    const labels = arr.map(e=>e.date);
    const values = arr.map(e=> Math.round(epley1RM(e.weight||0, e.reps||1)*10)/10 );
    if(chart) chart.destroy();
    chart = new Chart(can.getContext('2d'), {
      type:'line',
      data:{ labels, datasets:[{label:'Est. 1RM (kg)', data: values, borderColor:'#0b5fff', tension:0.2, pointRadius:2}] },
      options:{ maintainAspectRatio:false }
    });
  }
  sel.onchange = draw; draw();
}

function renderProj(){
  const root = document.getElementById('page-proj'); clear(root);

  const anchors = [];
  for (let w = 1; w <= 7; w++) {
    const wkDays = planDays.filter(x => x.week === w);
    if (wkDays.length) {
      anchors.push({ date: isoLocal(wkDays[0].date), ts: +new Date(wkDays[0].date), weight: wkDays[0].goal });
    }
  }
  const lastWeekDays = planDays.filter(x => x.week === 7);
  if (lastWeekDays.length) {
    const last = lastWeekDays[lastWeekDays.length - 1];
    anchors.push({ date: isoLocal(last.date), ts: +new Date(last.date), weight: last.goal });
  }
  const bw = LS.get(SK.BW); const bwMap = new Map(bw.map(x => [x.date, x.weight]));
  const proj = planDays.map(d => {
    const dLocal = isoLocal(d.date);
    const t = +new Date(d.date);
    let prev = anchors[0], next = anchors[anchors.length - 1];
    for (let i = 0; i < anchors.length - 1; i++) {
      if (t >= anchors[i].ts && t <= anchors[i+1].ts) { prev = anchors[i]; next = anchors[i+1]; break; }
      if (t < anchors[0].ts) { prev = anchors[0]; next = anchors[1]; break; }
      if (t > anchors[anchors.length-2].ts) { prev = anchors[anchors.length-2]; next = anchors[anchors.length-1]; break; }
    }
    const span = Math.max(1, next.ts - prev.ts);
    const alpha = Math.min(1, Math.max(0, (t - prev.ts) / span));
    const projected = +(prev.weight + (next.weight - prev.weight) * alpha).toFixed(1);
    return { date: dLocal, projected };
  });

  const labels   = proj.map(p => p.date);
  const projected= proj.map(p => p.projected);
  const realized = labels.map(d => bwMap.get(d) ?? null);

  const can = el('canvas'); can.height = 320;
  const card = el('div', { class: 'card' }, can);
  root.append(card);

  new Chart(can.getContext('2d'), {
    type: 'line',
    data: { labels, datasets: [
      { label: 'Projected (kg)', data: projected, borderColor: '#0b5fff', tension: 0.2, pointRadius: 0 },
      { label: 'Realized (kg)',  data: realized,  borderColor: '#16a34a', tension: 0.2, pointRadius: 3 }
    ]},
    options: { maintainAspectRatio: false }
  });
}

// Router
function showPage(id){
  window.__page = id;
  const ids=['tracker','train','bw','trends','proj'];
  ids.forEach(n=> document.getElementById('page-'+n).style.display = (n===id)?'block':'none');
  document.querySelectorAll('.tab').forEach((t,i)=> t.classList.toggle('active', ids[i]===id));
  if(id==='tracker') renderTracker();
  if(id==='train') renderTrain();
  if(id==='bw') renderBW();
  if(id==='trends') renderTrends();
  if(id==='proj') renderProj();
}
document.getElementById('tab-tracker').onclick = ()=>showPage('tracker');
document.getElementById('tab-train').onclick = ()=>showPage('train');
document.getElementById('tab-bw').onclick = ()=>showPage('bw');
document.getElementById('tab-trends').onclick = ()=>showPage('trends');
document.getElementById('tab-proj').onclick = ()=>showPage('proj');
showPage('tracker');

// PWA
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js').catch(()=>{})); }
</script>
</body>
</html>
